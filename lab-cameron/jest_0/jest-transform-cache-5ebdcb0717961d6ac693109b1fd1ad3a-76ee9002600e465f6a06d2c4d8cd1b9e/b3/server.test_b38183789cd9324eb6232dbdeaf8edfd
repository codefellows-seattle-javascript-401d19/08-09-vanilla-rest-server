087397222c4a674fda64906b23219e67
'use strict';

const server = require('../lib/server');
const superagent = require('superagent');

// data for testing
const testUserData = { name: 'name', description: 'description' };

describe('/api/users', () => {
  beforeAll(server.start);
  afterAll(server.stop);

  describe('GET requests', () => {
    test('GET should respond with a 200 status code and an array all resources', () => {
      const url = 'http://localhost:3000/api/users';

      // POST request for mock data
      return superagent.post(url).
      set('content-type', 'application/json').
      send(testUserData).
      then(() => {
        return superagent.post(url).
        set('content-type', 'application/json').
        send(testUserData).
        then(() => {
          return superagent.get(url).
          set('content-type', 'application/json').
          then(response => {
            expect(response.status).toEqual(200);
            expect(response.body[0].name).toEqual(testUserData.name);
            expect(response.body[0].description).toEqual(testUserData.description);
            expect(response.body[1].name).toEqual(testUserData.name);
            expect(response.body[1].description).toEqual(testUserData.description);
          });
        });
      });
    });

    test('GET should respond with a 200 status code an a single resource determined by uuid', () => {
      const url = 'http://localhost:3000/api/users';

      // POST request for mock data
      return superagent.post(url).
      set('content-type', 'application/json').
      send(testUserData).
      then(response => {
        const querystring = response.body.testId;
        return superagent.get(url).
        set('content-type', 'application/json').
        query({ id: `${querystring}` }).
        then(response => {
          expect(response.status).toEqual(200);
          expect(response.body.name).toEqual(testUserData.name);
          expect(response.body.description).toEqual(testUserData.description);
          expect(response.req.path).toEqual(`/api/users?id=${querystring}`);
        });
      });
    });

    test('GET should respond with a 404 if pathname requested is invalid', () => {
      const url = 'http://localhost:3000/invalid/pathname';
      return superagent.get(url).
      set('content-type', 'application/json').
      then(response => Promise.reject(response)).
      catch(response => {
        expect(response.status).toEqual(404);
      });
    });

    test('GET should respond with a 404 if id is not found', () => {
      const url = 'http://localhost:3000/api/users?id=notexisting';
      return superagent.get(url).
      set('content-type', 'application/json').
      then(response => Promise.reject(response)).
      catch(response => {
        expect(response.status).toEqual(404);
      });
    });
  });

  describe('POST requests', () => {
    test('POST should respond with a 200 status code and a body if there are no errors', () => {
      const url = 'http://localhost:3000/api/users';
      return superagent.post(url).
      set('content-type', 'application/json').
      send(testUserData).
      then(response => {
        expect(response.status).toEqual(200);
        expect(response.body.name).toEqual('name');
        expect(response.body.description).toEqual('description');
      });
    });

    test('POST should respond with a 400 if there is any error in data being passed', () => {
      const url = 'http://localhost:3000/api/users';
      const invalidJSON = '{';
      return superagent.post(url).
      set('content-type', 'application/json').
      send(invalidJSON).
      then(response => Promise.reject(response)).
      catch(response => {
        expect(response.status).toEqual(400);
      });
    });
  });

  describe('DELETE requests', () => {
    test('DELETE should respond with a 204 status code and have the specified user removed', () => {
      const url = 'http://localhost:3000/api/users';

      // POST requests for mock data
      return superagent.post(url).
      set('content-type', 'application/json').
      send(testUserData).
      then(response => {
        const querystring = response.body.testId;
        return superagent.delete(url).
        set('content-type', 'application/json').
        query({ id: `${querystring}` }).
        then(response => {
          console.log(response.body);
          expect(response.status).toEqual(204);
          expect(response.body).toEqual({});
          expect(response.req.path).toEqual(`/api/users?id=${querystring}`);
        });
      });
    });

    test('DELETE should respond with a 400 if id does not exist', () => {
      const url = 'http://localhost:3000/api/users?id=notexisting';

      // POST requests for mock data
      return superagent.post(url).
      set('content-type', 'application/json').
      send(testUserData).
      then(() => {
        return superagent.delete(url).
        set('content-type', 'application/json').
        then(response => Promise.reject(response)).
        catch(response => {
          console.log(response.body);
          expect(response.status).toEqual(400);
        });
      });
    });

    test('DELETE should respond with a 400 if no id is provided', () => {
      const url = 'http://localhost:3000/api/users';
      return superagent.delete(url).
      set('content-type', 'application/json').
      then(response => Promise.reject(response)).
      catch(response => {
        expect(response.status).toEqual(404);
      });
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNlcnZlci50ZXN0LmpzIl0sIm5hbWVzIjpbInNlcnZlciIsInJlcXVpcmUiLCJzdXBlcmFnZW50IiwidGVzdFVzZXJEYXRhIiwibmFtZSIsImRlc2NyaXB0aW9uIiwiZGVzY3JpYmUiLCJiZWZvcmVBbGwiLCJzdGFydCIsImFmdGVyQWxsIiwic3RvcCIsInRlc3QiLCJ1cmwiLCJwb3N0Iiwic2V0Iiwic2VuZCIsInRoZW4iLCJnZXQiLCJyZXNwb25zZSIsImV4cGVjdCIsInN0YXR1cyIsInRvRXF1YWwiLCJib2R5IiwicXVlcnlzdHJpbmciLCJ0ZXN0SWQiLCJxdWVyeSIsImlkIiwicmVxIiwicGF0aCIsIlByb21pc2UiLCJyZWplY3QiLCJjYXRjaCIsImludmFsaWRKU09OIiwiZGVsZXRlIiwiY29uc29sZSIsImxvZyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsTUFBTUEsU0FBU0MsUUFBUSxlQUFSLENBQWY7QUFDQSxNQUFNQyxhQUFhRCxRQUFRLFlBQVIsQ0FBbkI7O0FBRUE7QUFDQSxNQUFNRSxlQUFlLEVBQUVDLE1BQU0sTUFBUixFQUFnQkMsYUFBYSxhQUE3QixFQUFyQjs7QUFFQUMsU0FBUyxZQUFULEVBQXVCLE1BQU07QUFDM0JDLFlBQVVQLE9BQU9RLEtBQWpCO0FBQ0FDLFdBQVNULE9BQU9VLElBQWhCOztBQUVBSixXQUFTLGNBQVQsRUFBeUIsTUFBTTtBQUM3QkssU0FBSyxzRUFBTCxFQUE2RSxNQUFNO0FBQ2pGLFlBQU1DLE1BQU0saUNBQVo7O0FBRUE7QUFDQSxhQUFPVixXQUFXVyxJQUFYLENBQWdCRCxHQUFoQjtBQUNKRSxTQURJLENBQ0EsY0FEQSxFQUNnQixrQkFEaEI7QUFFSkMsVUFGSSxDQUVDWixZQUZEO0FBR0phLFVBSEksQ0FHQyxNQUFNO0FBQ1YsZUFBT2QsV0FBV1csSUFBWCxDQUFnQkQsR0FBaEI7QUFDSkUsV0FESSxDQUNBLGNBREEsRUFDZ0Isa0JBRGhCO0FBRUpDLFlBRkksQ0FFQ1osWUFGRDtBQUdKYSxZQUhJLENB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YUFBT1YsV0FBVytCLE1BQVgsQ0FBa0JyQixHQUFsQjtBQUNKRSxTQURJLENBQ0EsY0FEQSxFQUNnQixrQkFEaEI7QUFFSkUsVUFGSSxDQUVDRSxZQUFZVyxRQUFRQyxNQUFSLENBQWVaLFFBQWYsQ0FGYjtBQUdKYSxXQUhJLENBR0ViLFlBQVk7QUFDakJDLGVBQU9ELFNBQVNFLE1BQWhCLEVBQXdCQyxPQUF4QixDQUFnQyxHQUFoQztBQUNELE9BTEksQ0FBUDtBQU1ELEtBUkQ7QUFTRCxHQWpERDtBQWtERCxDQXBKRCIsImZpbGUiOiJzZXJ2ZXIudGVzdC5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3Qgc2VydmVyID0gcmVxdWlyZSgnLi4vbGliL3NlcnZlcicpO1xuY29uc3Qgc3VwZXJhZ2VudCA9IHJlcXVpcmUoJ3N1cGVyYWdlbnQnKTtcblxuLy8gZGF0YSBmb3IgdGVzdGluZ1xuY29uc3QgdGVzdFVzZXJEYXRhID0geyBuYW1lOiAnbmFtZScsIGRlc2NyaXB0aW9uOiAnZGVzY3JpcHRpb24nIH07XG5cbmRlc2NyaWJlKCcvYXBpL3VzZXJzJywgKCkgPT4ge1xuICBiZWZvcmVBbGwoc2VydmVyLnN0YXJ0KTtcbiAgYWZ0ZXJBbGwoc2VydmVyLnN0b3ApO1xuXG4gIGRlc2NyaWJlKCdHRVQgcmVxdWVzdHMnLCAoKSA9PiB7XG4gICAgdGVzdCgnR0VUIHNob3VsZCByZXNwb25kIHdpdGggYSAyMDAgc3RhdHVzIGNvZGUgYW5kIGFuIGFycmF5IGFsbCByZXNvdXJjZXMnLCAoKSA9PiB7XG4gICAgICBjb25zdCB1cmwgPSAnaHR0cDovL2xvY2FsaG9zdDozMDAwL2FwaS91c2Vycyc7XG5cbiAgICAgIC8vIFBPU1QgcmVxdWVzdCBmb3IgbW9jayBkYXRhXG4gICAgICByZXR1cm4gc3VwZXJhZ2VudC5wb3N0KHVybClcbiAgICAgICAgLnNldCgnY29udGVudC10eXBlJywgJ2FwcGxpY2F0aW9uL2pzb24nKVxuICAgICAgICAuc2VuZCh0ZXN0VXNlckRhdGEpXG4gICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICByZXR1cm4gc3VwZXJhZ2VudC5wb3N0KHVybClcbiAgICAgICAgICAgIC5zZXQoJ2NvbnRlbnQtdHlwZScsICdhcHBsaWNhdGlvbi9qc29uJylcbiAgICAgICAgICAgIC5zZW5kKHRlc3RVc2VyRGF0YSlcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgcmV0dXJuIHN1cGVyYWdlbnQuZ2V0KHVybClcbiAgICAgICAgICAgICAgICAuc2V0KCdjb250ZW50LXR5cGUnLCAnYXBwbGljYXRpb24vanNvbicpXG4gICAgICAgICAgICAgICAgLnRoZW4ocmVzcG9uc2UgPT4ge1xuICAgICAgICAgICAgICAgICAgZXhwZWN0KHJlc3BvbnNlLnN0YXR1cykudG9FcXVhbCgyMDApO1xuICAgICAgICAgICAgICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHlbMF0ubmFtZSkudG9FcXVhbCh0ZXN0VXNlckRhdGEubmFtZSk7XG4gICAgICAgICAgICAgICAgICBleHBlY3QocmVzcG9uc2UuYm9keVswXS5kZXNjcmlwdGlvbikudG9FcXVhbCh0ZXN0VXNlckRhdGEuZGVzY3JpcHRpb24pO1xuICAgICAgICAgICAgICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHlbMV0ubmFtZSkudG9FcXVhbCh0ZXN0VXNlckRhdGEubmFtZSk7XG4gICAgICAgICAgICAgICAgICBleHBlY3QocmVzcG9uc2UuYm9keVsxXS5kZXNjcmlwdGlvbikudG9FcXVhbCh0ZXN0VXNlckRhdGEuZGVzY3JpcHRpb24pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnR0VUIHNob3VsZCByZXNwb25kIHdpdGggYSAyMDAgc3RhdHVzIGNvZGUgYW4gYSBzaW5nbGUgcmVzb3VyY2UgZGV0ZXJtaW5lZCBieSB1dWlkJywgKCkgPT4ge1xuICAgICAgY29uc3QgdXJsID0gJ2h0dHA6Ly9sb2NhbGhvc3Q6MzAwMC9hcGkvdXNlcnMnO1xuXG4gICAgICAvLyBQT1NUIHJlcXVlc3QgZm9yIG1vY2sgZGF0YVxuICAgICAgcmV0dXJuIHN1cGVyYWdlbnQucG9zdCh1cmwpXG4gICAgICAgIC5zZXQoJ2NvbnRlbnQtdHlwZScsICdhcHBsaWNhdGlvbi9qc29uJylcbiAgICAgICAgLnNlbmQodGVzdFVzZXJEYXRhKVxuICAgICAgICAudGhlbihyZXNwb25zZSA9PiB7XG4gICAgICAgICAgY29uc3QgcXVlcnlzdHJpbmcgPSByZXNwb25zZS5ib2R5LnRlc3RJZDtcbiAgICAgICAgICByZXR1cm4gc3VwZXJhZ2VudC5nZXQodXJsKVxuICAgICAgICAgICAgLnNldCgnY29udGVudC10eXBlJywgJ2FwcGxpY2F0aW9uL2pzb24nKVxuICAgICAgICAgICAgLnF1ZXJ5KHsgaWQ6IGAke3F1ZXJ5c3RyaW5nfWAgfSlcbiAgICAgICAgICAgIC50aGVuKHJlc3BvbnNlID0+IHtcbiAgICAgICAgICAgICAgZXhwZWN0KHJlc3BvbnNlLnN0YXR1cykudG9FcXVhbCgyMDApO1xuICAgICAgICAgICAgICBleHBlY3QocmVzcG9uc2UuYm9keS5uYW1lKS50b0VxdWFsKHRlc3RVc2VyRGF0YS5uYW1lKTtcbiAgICAgICAgICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkuZGVzY3JpcHRpb24pLnRvRXF1YWwodGVzdFVzZXJEYXRhLmRlc2NyaXB0aW9uKTtcbiAgICAgICAgICAgICAgZXhwZWN0KHJlc3BvbnNlLnJlcS5wYXRoKS50b0VxdWFsKGAvYXBpL3VzZXJzP2lkPSR7cXVlcnlzdHJpbmd9YCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdHRVQgc2hvdWxkIHJlc3BvbmQgd2l0aCBhIDQwNCBpZiBwYXRobmFtZSByZXF1ZXN0ZWQgaXMgaW52YWxpZCcsICgpID0+IHtcbiAgICAgIGNvbnN0IHVybCA9ICdodHRwOi8vbG9jYWxob3N0OjMwMDAvaW52YWxpZC9wYXRobmFtZSc7XG4gICAgICByZXR1cm4gc3VwZXJhZ2VudC5nZXQodXJsKVxuICAgICAgICAuc2V0KCdjb250ZW50LXR5cGUnLCAnYXBwbGljYXRpb24vanNvbicpXG4gICAgICAgIC50aGVuKHJlc3BvbnNlID0+IFByb21pc2UucmVqZWN0KHJlc3BvbnNlKSlcbiAgICAgICAgLmNhdGNoKHJlc3BvbnNlID0+IHtcbiAgICAgICAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzKS50b0VxdWFsKDQwNCk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnR0VUIHNob3VsZCByZXNwb25kIHdpdGggYSA0MDQgaWYgaWQgaXMgbm90IGZvdW5kJywgKCkgPT4ge1xuICAgICAgY29uc3QgdXJsID0gJ2h0dHA6Ly9sb2NhbGhvc3Q6MzAwMC9hcGkvdXNlcnM/aWQ9bm90ZXhpc3RpbmcnO1xuICAgICAgcmV0dXJuIHN1cGVyYWdlbnQuZ2V0KHVybClcbiAgICAgICAgLnNldCgnY29udGVudC10eXBlJywgJ2FwcGxpY2F0aW9uL2pzb24nKVxuICAgICAgICAudGhlbihyZXNwb25zZSA9PiBQcm9taXNlLnJlamVjdChyZXNwb25zZSkpXG4gICAgICAgIC5jYXRjaChyZXNwb25zZSA9PiB7XG4gICAgICAgICAgZXhwZWN0KHJlc3BvbnNlLnN0YXR1cykudG9FcXVhbCg0MDQpO1xuICAgICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1BPU1QgcmVxdWVzdHMnLCAoKSA9PiB7XG4gICAgdGVzdCgnUE9TVCBzaG91bGQgcmVzcG9uZCB3aXRoIGEgMjAwIHN0YXR1cyBjb2RlIGFuZCBhIGJvZHkgaWYgdGhlcmUgYXJlIG5vIGVycm9ycycsICgpID0+IHtcbiAgICAgIGNvbnN0IHVybCA9ICdodHRwOi8vbG9jYWxob3N0OjMwMDAvYXBpL3VzZXJzJztcbiAgICAgIHJldHVybiBzdXBlcmFnZW50LnBvc3QodXJsKVxuICAgICAgICAuc2V0KCdjb250ZW50LXR5cGUnLCAnYXBwbGljYXRpb24vanNvbicpXG4gICAgICAgIC5zZW5kKHRlc3RVc2VyRGF0YSlcbiAgICAgICAgLnRoZW4ocmVzcG9uc2UgPT4ge1xuICAgICAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXMpLnRvRXF1YWwoMjAwKTtcbiAgICAgICAgICBleHBlY3QocmVzcG9uc2UuYm9keS5uYW1lKS50b0VxdWFsKCduYW1lJyk7XG4gICAgICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkuZGVzY3JpcHRpb24pLnRvRXF1YWwoJ2Rlc2NyaXB0aW9uJyk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnUE9TVCBzaG91bGQgcmVzcG9uZCB3aXRoIGEgNDAwIGlmIHRoZXJlIGlzIGFueSBlcnJvciBpbiBkYXRhIGJlaW5nIHBhc3NlZCcsICgpID0+IHtcbiAgICAgIGNvbnN0IHVybCA9ICdodHRwOi8vbG9jYWxob3N0OjMwMDAvYXBpL3VzZXJzJztcbiAgICAgIGNvbnN0IGludmFsaWRKU09OID0gJ3snO1xuICAgICAgcmV0dXJuIHN1cGVyYWdlbnQucG9zdCh1cmwpXG4gICAgICAgIC5zZXQoJ2NvbnRlbnQtdHlwZScsICdhcHBsaWNhdGlvbi9qc29uJylcbiAgICAgICAgLnNlbmQoaW52YWxpZEpTT04pXG4gICAgICAgIC50aGVuKHJlc3BvbnNlID0+IFByb21pc2UucmVqZWN0KHJlc3BvbnNlKSlcbiAgICAgICAgLmNhdGNoKHJlc3BvbnNlID0+IHtcbiAgICAgICAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzKS50b0VxdWFsKDQwMCk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnREVMRVRFIHJlcXVlc3RzJywgKCkgPT4ge1xuICAgIHRlc3QoJ0RFTEVURSBzaG91bGQgcmVzcG9uZCB3aXRoIGEgMjA0IHN0YXR1cyBjb2RlIGFuZCBoYXZlIHRoZSBzcGVjaWZpZWQgdXNlciByZW1vdmVkJywgKCkgPT4ge1xuICAgICAgY29uc3QgdXJsID0gJ2h0dHA6Ly9sb2NhbGhvc3Q6MzAwMC9hcGkvdXNlcnMnO1xuXG4gICAgICAvLyBQT1NUIHJlcXVlc3RzIGZvciBtb2NrIGRhdGFcbiAgICAgIHJldHVybiBzdXBlcmFnZW50LnBvc3QodXJsKVxuICAgICAgICAuc2V0KCdjb250ZW50LXR5cGUnLCAnYXBwbGljYXRpb24vanNvbicpXG4gICAgICAgIC5zZW5kKHRlc3RVc2VyRGF0YSlcbiAgICAgICAgLnRoZW4ocmVzcG9uc2UgPT4ge1xuICAgICAgICAgIGNvbnN0IHF1ZXJ5c3RyaW5nID0gcmVzcG9uc2UuYm9keS50ZXN0SWQ7XG4gICAgICAgICAgcmV0dXJuIHN1cGVyYWdlbnQuZGVsZXRlKHVybClcbiAgICAgICAgICAgIC5zZXQoJ2NvbnRlbnQtdHlwZScsICdhcHBsaWNhdGlvbi9qc29uJylcbiAgICAgICAgICAgIC5xdWVyeSh7IGlkOiBgJHtxdWVyeXN0cmluZ31gIH0pXG4gICAgICAgICAgICAudGhlbihyZXNwb25zZSA9PiB7XG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKHJlc3BvbnNlLmJvZHkpO1xuICAgICAgICAgICAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzKS50b0VxdWFsKDIwNCk7XG4gICAgICAgICAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5KS50b0VxdWFsKHt9KTtcbiAgICAgICAgICAgICAgZXhwZWN0KHJlc3BvbnNlLnJlcS5wYXRoKS50b0VxdWFsKGAvYXBpL3VzZXJzP2lkPSR7cXVlcnlzdHJpbmd9YCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdERUxFVEUgc2hvdWxkIHJlc3BvbmQgd2l0aCBhIDQwMCBpZiBpZCBkb2VzIG5vdCBleGlzdCcsICgpID0+IHtcbiAgICAgIGNvbnN0IHVybCA9ICdodHRwOi8vbG9jYWxob3N0OjMwMDAvYXBpL3VzZXJzP2lkPW5vdGV4aXN0aW5nJztcblxuICAgICAgLy8gUE9TVCByZXF1ZXN0cyBmb3IgbW9jayBkYXRhXG4gICAgICByZXR1cm4gc3VwZXJhZ2VudC5wb3N0KHVybClcbiAgICAgICAgLnNldCgnY29udGVudC10eXBlJywgJ2FwcGxpY2F0aW9uL2pzb24nKVxuICAgICAgICAuc2VuZCh0ZXN0VXNlckRhdGEpXG4gICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICByZXR1cm4gc3VwZXJhZ2VudC5kZWxldGUodXJsKVxuICAgICAgICAgICAgLnNldCgnY29udGVudC10eXBlJywgJ2FwcGxpY2F0aW9uL2pzb24nKVxuICAgICAgICAgICAgLnRoZW4ocmVzcG9uc2UgPT4gUHJvbWlzZS5yZWplY3QocmVzcG9uc2UpKVxuICAgICAgICAgICAgLmNhdGNoKHJlc3BvbnNlID0+IHtcbiAgICAgICAgICAgICAgY29uc29sZS5sb2cocmVzcG9uc2UuYm9keSk7XG4gICAgICAgICAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXMpLnRvRXF1YWwoNDAwKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ0RFTEVURSBzaG91bGQgcmVzcG9uZCB3aXRoIGEgNDAwIGlmIG5vIGlkIGlzIHByb3ZpZGVkJywgKCkgPT4ge1xuICAgICAgY29uc3QgdXJsID0gJ2h0dHA6Ly9sb2NhbGhvc3Q6MzAwMC9hcGkvdXNlcnMnO1xuICAgICAgcmV0dXJuIHN1cGVyYWdlbnQuZGVsZXRlKHVybClcbiAgICAgICAgLnNldCgnY29udGVudC10eXBlJywgJ2FwcGxpY2F0aW9uL2pzb24nKVxuICAgICAgICAudGhlbihyZXNwb25zZSA9PiBQcm9taXNlLnJlamVjdChyZXNwb25zZSkpXG4gICAgICAgIC5jYXRjaChyZXNwb25zZSA9PiB7XG4gICAgICAgICAgZXhwZWN0KHJlc3BvbnNlLnN0YXR1cykudG9FcXVhbCg0MDQpO1xuICAgICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdfQ==